---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import EmailCapture from '../../components/EmailCapture.astro';
import FAQ from '../../components/FAQ.astro';

const breadcrumbs = [
  { name: 'Home', url: '/' },
  { name: 'Festival Calendar', url: '/festivals/' },
];

const pageTitle = 'Italian Festival Calendar 2026';
const pageDescription = 'From Venice\'s legendary Carnival to Siena\'s Palio horse race — time your trip to the festivals and celebrations that define each Italian destination.';

const festivals = [
  {
    month: 'Jan',
    monthIndex: 0,
    name: 'Epiphany & La Befana',
    destination: 'Rome & nationwide',
    slug: 'rome',
    description: 'January 6 marks the end of the Christmas season with the legend of La Befana — a friendly witch who delivers gifts to children. Rome\'s Piazza Navona hosts a festive market with puppet shows, sweets, and street performers.',
  },
  {
    month: 'Feb',
    monthIndex: 1,
    name: 'Carnevale di Venezia',
    destination: 'Venice',
    slug: 'venice',
    description: 'The world\'s most famous carnival — two weeks of elaborate masks, Renaissance costumes, gondola parades, and masquerade balls across Venice\'s piazzas and palazzi. The Grand Canal parade and Piazza San Marco are the epicenter of spectacle.',
  },
  {
    month: 'Feb',
    monthIndex: 1,
    name: 'Carnevale di Viareggio',
    destination: 'Viareggio (Tuscany)',
    slug: 'tuscany',
    description: 'Giant papier-mache floats — some 20 meters tall — parade through this Tuscan seaside town in a carnival tradition dating to 1873. The floats are satirical, political, and wildly creative.',
  },
  {
    month: 'Feb',
    monthIndex: 1,
    name: 'Festa di Sant\'Agata',
    destination: 'Catania (Sicily)',
    slug: 'sicily',
    description: 'Catania\'s patron saint festival draws a million devotees over three days. Candlelit processions carry the saint\'s silver reliquary through packed streets — one of the most intense religious celebrations in southern Italy.',
  },
  {
    month: 'Mar',
    monthIndex: 2,
    name: 'Settimana Santa (Holy Week)',
    destination: 'Throughout Italy',
    slug: 'rome',
    description: 'Easter celebrations across Italy feature dramatic processions, passion plays, and centuries-old traditions. The Pope leads Easter Mass in St. Peter\'s Square. Florence\'s Scoppio del Carro (Explosion of the Cart) is a pyrotechnic spectacle on Easter Sunday.',
  },
  {
    month: 'Apr',
    monthIndex: 3,
    name: 'Festa della Liberazione',
    destination: 'Nationwide',
    slug: 'rome',
    description: 'April 25 commemorates Italy\'s liberation from Nazi occupation in 1945. Concerts, parades, and public ceremonies take place nationwide. Milan and Rome host the largest events with political speeches, marching bands, and community gatherings.',
  },
  {
    month: 'Apr',
    monthIndex: 3,
    name: 'Vinitaly',
    destination: 'Verona',
    slug: 'verona',
    description: 'The world\'s largest wine fair takes over Verona\'s exhibition center with 4,000+ Italian and international producers. Open to the public on select days — an unmissable event for wine lovers visiting the Veneto.',
  },
  {
    month: 'May',
    monthIndex: 4,
    name: 'Festa dei Ceri',
    destination: 'Gubbio (Umbria)',
    slug: 'tuscany',
    description: 'Teams of ceraioli race through Gubbio\'s medieval streets carrying massive wooden pillars (ceri) weighing 400 kg each to the basilica atop Monte Ingino. One of Italy\'s most thrilling and ancient festivals, held May 15.',
  },
  {
    month: 'May',
    monthIndex: 4,
    name: 'Maggio Musicale Fiorentino',
    destination: 'Florence',
    slug: 'florence',
    description: 'Florence\'s prestigious music and performing arts festival runs from May through June with opera, ballet, and orchestral concerts in historic venues across the city. Founded in 1933, it\'s one of Europe\'s oldest arts festivals.',
  },
  {
    month: 'Jun',
    monthIndex: 5,
    name: 'Festa della Repubblica',
    destination: 'Rome & nationwide',
    slug: 'rome',
    description: 'June 2 celebrates the birth of the Italian Republic with a grand military parade along Via dei Fori Imperiali in Rome, air force flyovers, and the opening of the Quirinale Palace gardens to the public.',
  },
  {
    month: 'Jun',
    monthIndex: 5,
    name: 'Infiorata di Spello',
    destination: 'Spello (Umbria)',
    slug: 'tuscany',
    description: 'On Corpus Domini weekend, the streets of this Umbrian hill town are covered in elaborate flower petal carpets — intricate mosaics created overnight by teams of local artists. A breathtaking display of community artistry.',
  },
  {
    month: 'Jun',
    monthIndex: 5,
    name: 'Calcio Storico Fiorentino',
    destination: 'Florence',
    slug: 'florence',
    description: 'A brutal 16th-century mix of rugby, soccer, and wrestling played in Renaissance costume on a sand pitch in Piazza Santa Croce. Three matches in June culminate in the final on June 24, the feast of San Giovanni. Not for the faint-hearted.',
  },
  {
    month: 'Jul',
    monthIndex: 6,
    name: 'Palio di Siena',
    destination: 'Siena (Tuscany)',
    slug: 'tuscany',
    description: 'A bareback horse race around Piazza del Campo that has divided Siena\'s 17 contrade (neighborhoods) since 1644. The July 2 and August 16 races are preceded by days of feasting, pageantry, and fierce neighborhood rivalry. Standing in the center of the piazza is free.',
  },
  {
    month: 'Jul',
    monthIndex: 6,
    name: 'Festa del Redentore',
    destination: 'Venice',
    slug: 'venice',
    description: 'Venice celebrates the end of a 1576 plague with a spectacular fireworks display over the Giudecca Canal. Venetians picnic on decorated boats, and a temporary pontoon bridge connects to the Church of the Redentore. Third weekend of July.',
  },
  {
    month: 'Jul',
    monthIndex: 6,
    name: 'Umbria Jazz',
    destination: 'Perugia (Umbria)',
    slug: 'tuscany',
    description: 'One of Europe\'s premier jazz festivals transforms Perugia\'s medieval streets and piazzas into open-air concert venues for 10 days each July. International headliners and free outdoor performances draw music lovers from across the continent.',
  },
  {
    month: 'Aug',
    monthIndex: 7,
    name: 'Ferragosto',
    destination: 'Nationwide',
    slug: 'rome',
    description: 'August 15 is Italy\'s biggest summer holiday — the entire country heads to the beach or mountains. Cities empty out, shops close, and coastal towns overflow. Beach parties, fireworks, and communal dinners happen everywhere. Book everything months ahead.',
  },
  {
    month: 'Aug',
    monthIndex: 7,
    name: 'Palio di Siena (August)',
    destination: 'Siena (Tuscany)',
    slug: 'tuscany',
    description: 'The second Palio of the year runs August 16 with the same intensity as July. Ten of the 17 contrade race — if your neighborhood lost in July, the August race is a shot at redemption. The city-wide passion is palpable.',
  },
  {
    month: 'Aug',
    monthIndex: 7,
    name: 'La Notte della Taranta',
    destination: 'Melpignano (Puglia)',
    slug: 'puglia',
    description: 'The largest music festival in Southern Italy celebrates the pizzica — a frenzied folk dance from Salento. Over 100,000 people gather in Melpignano\'s piazza for an all-night concert blending traditional tarantella with world music.',
  },
  {
    month: 'Sep',
    monthIndex: 8,
    name: 'Regata Storica',
    destination: 'Venice',
    slug: 'venice',
    description: 'A spectacular procession of 16th-century boats along the Grand Canal, followed by competitive gondola races. Venetians in Renaissance costume row decorated bissone while crowds cheer from the banks. First Sunday of September.',
  },
  {
    month: 'Sep',
    monthIndex: 8,
    name: 'Festa di San Gennaro',
    destination: 'Naples',
    slug: 'naples',
    description: 'Naples holds its breath on September 19 as the blood of San Gennaro is displayed in the cathedral — if it liquefies, the city is blessed for the coming year. If not, Neapolitans brace for disaster. A spectacle of devotion and superstition.',
  },
  {
    month: 'Oct',
    monthIndex: 9,
    name: 'Eurochocolate',
    destination: 'Perugia (Umbria)',
    slug: 'tuscany',
    description: 'Europe\'s largest chocolate festival fills Perugia\'s historic center with tastings, workshops, sculptures made of chocolate, and stands from Italy\'s and Europe\'s finest chocolatiers. Ten days in mid-October.',
  },
  {
    month: 'Oct',
    monthIndex: 9,
    name: 'Alba White Truffle Fair',
    destination: 'Alba (Piedmont)',
    slug: 'piedmont',
    description: 'The world\'s most prestigious truffle market — dealers auction prized tartufo bianco for thousands of euros per kilo while visitors taste truffle dishes, attend cooking demos, and enjoy a donkey palio. October through November.',
  },
  {
    month: 'Nov',
    monthIndex: 10,
    name: 'Festa della Salute',
    destination: 'Venice',
    slug: 'venice',
    description: 'November 21 marks Venice\'s thanksgiving for deliverance from plague. Venetians cross a temporary pontoon bridge to the Basilica della Salute. A deeply local celebration with candle processions and traditional castradina (lamb stew).',
  },
  {
    month: 'Dec',
    monthIndex: 11,
    name: 'Christmas Markets',
    destination: 'Bolzano, Trento & Northern Italy',
    slug: 'dolomites',
    description: 'The Dolomites and Alto Adige region host some of the most charming Christmas markets in Europe — Germanic-influenced wooden chalets selling handcrafts, mulled wine (Gluhwein), and roasted chestnuts. Bolzano, Merano, and Trento are the most atmospheric.',
  },
  {
    month: 'Dec',
    monthIndex: 11,
    name: 'Presepe Vivente (Living Nativity)',
    destination: 'Matera & Southern Italy',
    slug: 'puglia',
    description: 'Matera\'s ancient cave dwellings (Sassi) become the setting for a living nativity scene with costumed performers, livestock, and artisan workshops recreating biblical-era life. Similar events happen across Sicily and Calabria throughout December.',
  },
];


const months = [
  'January', 'February', 'March', 'April', 'May', 'June',
  'July', 'August', 'September', 'October', 'November', 'December',
];

const monthGradients = [
  'linear-gradient(135deg, #E8654A 0%, #D4A853 100%)',
  'linear-gradient(135deg, #C05299 0%, #E8654A 100%)',
  'linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%)',
  'linear-gradient(135deg, #FF9800 0%, #FFC107 100%)',
  'linear-gradient(135deg, #9E9E9E 0%, #BDBDBD 100%)',
  'linear-gradient(135deg, #0D7377 0%, #4DB6AC 100%)',
  'linear-gradient(135deg, #1565C0 0%, #42A5F5 100%)',
  'linear-gradient(135deg, #6A1B9A 0%, #AB47BC 100%)',
  'linear-gradient(135deg, #9E9E9E 0%, #BDBDBD 100%)',
  'linear-gradient(135deg, #E65100 0%, #FF9800 100%)',
  'linear-gradient(135deg, #BF360C 0%, #E8654A 100%)',
  'linear-gradient(135deg, #1A2332 0%, #C62828 0%, #FFD54F 100%)',
];

// Extract first color from each month gradient for map markers
const monthColors = [
  '#E8654A', '#C05299', '#4CAF50', '#FF9800', '#9E9E9E', '#0D7377',
  '#1565C0', '#6A1B9A', '#9E9E9E', '#E65100', '#BF360C', '#C62828',
];

// Geo coordinates for festival map markers
const geoLookup: Record<string, { lat: number; lng: number; label: string }> = {
  rome: { lat: 41.9028, lng: 12.4964, label: 'Rome' },
  venice: { lat: 45.4408, lng: 12.3155, label: 'Venice' },
  florence: { lat: 43.7696, lng: 11.2558, label: 'Florence' },
  naples: { lat: 40.8518, lng: 14.2681, label: 'Naples' },
  tuscany: { lat: 43.3188, lng: 11.3308, label: 'Siena' },
  sicily: { lat: 37.5079, lng: 15.0830, label: 'Catania' },
  verona: { lat: 45.4384, lng: 10.9916, label: 'Verona' },
  puglia: { lat: 40.3515, lng: 18.1750, label: 'Lecce' },
  piedmont: { lat: 44.6940, lng: 8.0353, label: 'Alba' },
  dolomites: { lat: 46.4983, lng: 11.3548, label: 'Bolzano' },
};

// Build map markers — group festivals by slug (one marker per location)
const festBySlug = new Map<string, typeof festivals>();
festivals.forEach(f => {
  const arr = festBySlug.get(f.slug) || [];
  arr.push(f);
  festBySlug.set(f.slug, arr);
});

const festMapMarkers = Array.from(festBySlug.entries())
  .map(([slug, fests]) => {
    const geo = geoLookup[slug];
    if (!geo) return null;
    return {
      lat: geo.lat,
      lng: geo.lng,
      label: geo.label,
      slug,
      color: monthColors[fests[0].monthIndex],
      url: `/destinations/${slug}/`,
      festivals: fests.map(f => ({
        name: f.name,
        month: f.month,
        destination: f.destination,
      })),
    };
  })
  .filter(Boolean);

// Video lookup for festival cards — prefer preview (smallest), then break-1, then hero
const festCardVideos: Record<string, string> = {};
// Destinations with preview videos
['rome','venice','florence','naples','sicily','tuscany','puglia','verona','dolomites','piedmont']
  .forEach(s => festCardVideos[s] = `/videos/destinations/${s}-preview.mp4`);

// Fallback cycle for any slug not in lookup
const fallbackVideos = Object.values(festCardVideos);

// 10 generic festival clips — cycle 3x across 32 events
const festGenericClips = Array.from({ length: 10 }, (_, i) => `/videos/pillar/festival-card-${i + 1}.mp4`);

---
<BaseLayout
  title={pageTitle}
  description={pageDescription}
  pageType="destination"
  breadcrumbs={breadcrumbs}
>
  <!-- Hero -->
  <header class="fest-hero">
    <video class="fest-hero-video" autoplay muted loop playsinline preload="metadata">
      <source src="/videos/pillar/festivals-hero.mp4" type="video/mp4" />
    </video>
    <div class="fest-hero-gradient"></div>
    <div class="fest-hero-noise"></div>

    <div class="fest-hero-content">
      <h1 class="fest-hero-title">Italian Festival Calendar 2026</h1>
      <p class="fest-hero-subtitle">From Venice's legendary Carnival to Siena's Palio horse race — time your trip to the festivals and celebrations that define each Italian destination.</p>
      <div class="fest-hero-meta">
        <div class="fest-hero-meta-item">
          <span class="fest-hero-meta-label">Festivals</span>
          <span class="fest-hero-meta-value">25</span>
        </div>
        <div class="fest-hero-meta-item">
          <span class="fest-hero-meta-label">Destinations</span>
          <span class="fest-hero-meta-value">10+</span>
        </div>
        <div class="fest-hero-meta-item">
          <span class="fest-hero-meta-label">Season</span>
          <span class="fest-hero-meta-value">Year-Round</span>
        </div>
      </div>
    </div>

    <div class="fest-scroll-hint">Scroll<br />&#8595;</div>
  </header>

  <!-- Breadcrumb -->
  <div class="container-content">
    <Breadcrumb items={breadcrumbs} />
  </div>

  <!-- Personal intro -->
  <section class="fest-personal reveal">
    <div class="container-content">
      <blockquote class="fest-personal-quote">
        <p>Italians celebrate everything — patron saints, historical victories, harvests, the changing of seasons, and things that simply deserve a party. Every town has its own sagra (food festival), every city has a patron saint feast day, and the entire country shuts down for Ferragosto in August. We try to plan around at least one festival every trip — they're the fastest way to experience the real Italy, not the tourist version.</p>
        <cite>— Scott &amp; Scott</cite>
      </blockquote>
    </div>
  </section>

  <!-- View Toggle -->
  <div class="container-content" style="padding-top: var(--space-2); padding-bottom: var(--space-4);">
    <div class="fest-view-toggle">
      <button class="fest-toggle-btn active" id="festBtnCalendar">Calendar</button>
      <button class="fest-toggle-btn" id="festBtnMap">Map</button>
    </div>
  </div>

  <!-- Calendar Grid -->
  <div id="festCalendarView">
  <section class="fest-calendar reveal">
    <div class="container-content">
      <h2 class="fest-section-heading">Festivals by Month</h2>
      <p class="fest-section-sub">Click any festival to explore its destination. Hover for a preview.</p>

      <div class="fest-month-grid">
        {months.map((monthName, i) => {
          const monthFestivals = festivals.filter(f => f.monthIndex === i);
          return (
            <div class="fest-month-card reveal">
              <div class="fest-month-header">
                <span class="fest-month-name">{monthName}</span>
                {monthFestivals.length > 0 && (
                  <span class="fest-month-count">{monthFestivals.length}</span>
                )}
              </div>
              <div class="fest-month-body">
                {monthFestivals.length > 0 ? (
                  monthFestivals.map((fest) => {
                    const idx = festivals.indexOf(fest);
                    const destVideo = festCardVideos[fest.slug] || fallbackVideos[idx % fallbackVideos.length];
                    const festVideo = festGenericClips[idx % festGenericClips.length];
                    return (
                    <a href={`/destinations/${fest.slug}/`} class="fest-entry">
                      <div class="fest-entry-media" style={`background: ${monthGradients[i]};`}>
                        <video class="fest-card-video fest-vid-dest" muted loop playsinline preload="none" data-src={destVideo}></video>
                        <video class="fest-card-video fest-vid-fest" muted loop playsinline preload="none" data-src={festVideo} style="opacity:0;"></video>
                        <div class="fest-card-scrim"></div>
                        <div class="fest-entry-media-label">{fest.month}</div>
                      </div>
                      <div class="fest-entry-info">
                        <div class="fest-entry-name">{fest.name}</div>
                        <div class="fest-entry-destination">{fest.destination}</div>
                      </div>
                      <div class="fest-entry-overlay">
                        <p class="fest-entry-desc">{fest.description}</p>
                        <span class="fest-entry-cta">Explore {fest.destination} &rarr;</span>
                      </div>
                    </a>
                  );})
                ) : (
                  <div class="fest-month-empty">No major festivals</div>
                )}
              </div>
            </div>
          );
        })}
      </div>
    </div>
  </section>

  </div><!-- /festCalendarView -->

  <!-- Map View (hidden by default) -->
  <div id="festMapView" style="display:none;">
    <section style="padding: var(--space-4) 0 var(--space-8);">
      <div class="container-content">
        <div class="fest-map-container" id="festMapContainer">
          <div class="fest-map-tooltip" id="festMapTooltip">
            <div class="fest-map-tooltip-name" id="festTooltipName"></div>
            <div class="fest-map-tooltip-fests" id="festTooltipFests"></div>
          </div>
          <div id="festLeafletMap"></div>
          <div class="fest-map-legend">
            <div class="fest-map-legend-item"><div class="fest-map-legend-dot" style="background:var(--color-warm-coral);"></div>Festival location</div>
            <div class="fest-map-legend-note">Colored by month &middot; Click to explore destination</div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Bottom CTA -->
  <section class="fest-cta-section reveal">
    <div class="container-content">
      <div class="fest-cta-card">
        <h2 class="fest-cta-heading">Plan Your Festival Trip</h2>
        <p class="fest-cta-text">Let our AI travel planner build a custom itinerary around the festivals you want to see — with flights, hotels, and day-by-day schedules.</p>
        <a href="/plan/" class="fest-cta-button">Start Planning &rarr;</a>
      </div>
    </div>
  </section>

  <!-- FAQ -->
  <FAQ items={[
    { question: "What are the biggest festivals in Italy?", answer: "Carnevale di Venezia (Venice, February) is the most internationally famous — two weeks of elaborate masks and costume balls. The Palio di Siena (July and August) is a bareback horse race steeped in medieval rivalry. Ferragosto (August 15) is the biggest national holiday. La Notte della Taranta (August, Puglia) is the largest music festival in southern Italy, drawing over 100,000 people." },
    { question: "When is Venice Carnival?", answer: "Carnevale di Venezia typically runs for two weeks in February, ending on Shrove Tuesday (Martedi Grasso). Exact dates shift yearly based on Easter. The main events are mask parades on Piazza San Marco, the Grand Canal regatta, and masquerade balls in historic palazzi. Book accommodation 3-4 months ahead — Venice fills up and prices double during Carnival." },
    { question: "How do I plan a trip around an Italian festival?", answer: "Pick your festival, then book accommodation 2-4 months early — prices spike and rooms sell out during major events like Venice Carnival, Palio di Siena, and Ferragosto week. Arrive a day or two before the main event to soak up the atmosphere. Use our AI Trip Planner at /plan/ to build a festival-centered itinerary with transport and hotel bookings." },
    { question: "Are Italian festivals safe for tourists?", answer: "Italian festivals are very safe and locals welcome foreign visitors warmly. The main concern is pickpocketing in dense crowds — especially in Venice, Rome, and Naples during major events. Keep valuables secure, use a crossbody bag, and stay aware in packed piazzas. Summer festivals require sunscreen, water, and comfortable shoes for hours of standing." },
    { question: "What is Ferragosto?", answer: "Ferragosto (August 15) is Italy's biggest summer holiday — a national celebration dating back to Emperor Augustus. The entire country heads to the beach or mountains. Cities empty out, most shops and restaurants close, and coastal towns overflow. Book everything months in advance. If you're in Italy during Ferragosto, embrace it: every town has fireworks, beach parties, or communal dinners." },
    { question: "What is the Palio di Siena?", answer: "A bareback horse race around Siena's shell-shaped Piazza del Campo, held July 2 and August 16. Ten of Siena's 17 contrade (neighborhoods) compete in a race that lasts about 90 seconds — but the pageantry, feasting, and neighborhood rivalry last for days. Standing in the center of the piazza is free but arrives early (by noon for a 7 PM race). It's been running since 1644." },
  ]} />

  <!-- Email Capture -->
  <div class="container-content reveal" style="padding-bottom: var(--space-6);">
    <EmailCapture
      leadMagnet="Get Our Free Festival Trip Planner"
      description="A month-by-month PDF guide to Italian festivals — with travel logistics, accommodation tips, and what to expect at each celebration."
      bullets={[
        'All 25 festivals with exact dates and locations',
        'Train connections and where to stay for each event',
        'Insider tips — best viewing spots, what to wear, what to bring',
        'Suggested multi-festival itineraries by region',
      ]}
      guideTag="pillar-festivals"
    />
  </div>

  <!-- Cross-links -->
  <section class="fest-crosslinks reveal">
    <div class="container-content">
      <h3 class="fest-crosslinks-heading">Explore More</h3>
      <div class="fest-crosslinks-grid">
        <a href="/cuisine/" class="fest-crosslink-card">
          <span class="fest-crosslink-icon">&#127860;</span>
          <span class="fest-crosslink-label">Food & Cuisine</span>
          <span class="fest-crosslink-desc">Regional Italian dishes with where to find the best version</span>
        </a>
        <a href="/destinations/" class="fest-crosslink-card">
          <span class="fest-crosslink-icon">&#127965;</span>
          <span class="fest-crosslink-label">All Destinations</span>
          <span class="fest-crosslink-desc">Every city and region we've explored with honest reviews</span>
        </a>
      </div>
    </div>
  </section>

</BaseLayout>

<!-- Scroll Reveal Observer -->
<script>
  if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
    const revealObserver = new IntersectionObserver(
      (entries) => {
        entries.forEach((e) => {
          if (e.isIntersecting) {
            e.target.classList.add('visible');
          }
        });
      },
      { threshold: 0.1, rootMargin: '0px 0px -40px 0px' }
    );
    document.querySelectorAll('.reveal').forEach((el) => revealObserver.observe(el));
  } else {
    document.querySelectorAll('.reveal').forEach((el) => el.classList.add('visible'));
  }
</script>

<!-- Festival card video lazy-load + dual-video cycling -->
<script>
  const festMediaEls = document.querySelectorAll('.fest-entry-media');
  const festSwapTimers = new Map<Element, number>();

  function festLoadAndPlay(video: HTMLVideoElement) {
    if (!video.src && video.dataset.src) {
      video.src = video.dataset.src;
    }
    video.play().catch(() => {});
  }

  function festStartCycle(media: Element) {
    const dest = media.querySelector<HTMLVideoElement>('.fest-vid-dest');
    const fest = media.querySelector<HTMLVideoElement>('.fest-vid-fest');
    if (!dest || !fest) return;

    festLoadAndPlay(dest);
    festLoadAndPlay(fest);

    // Start with dest visible, swap every 6 seconds
    let showingDest = true;
    const timer = window.setInterval(() => {
      showingDest = !showingDest;
      dest.style.opacity = showingDest ? '1' : '0';
      fest.style.opacity = showingDest ? '0' : '1';
    }, 6000);
    festSwapTimers.set(media, timer);
  }

  function festStopCycle(media: Element) {
    const timer = festSwapTimers.get(media);
    if (timer) {
      clearInterval(timer);
      festSwapTimers.delete(media);
    }
    media.querySelectorAll<HTMLVideoElement>('.fest-card-video').forEach(v => v.pause());
  }

  const festObserver = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          festStartCycle(entry.target);
        } else {
          festStopCycle(entry.target);
        }
      });
    },
    { threshold: 0.2, rootMargin: '100px' }
  );
  festMediaEls.forEach((el) => festObserver.observe(el));
</script>

<!-- View Toggle Logic -->
<script>
  const festBtnCalendar = document.getElementById('festBtnCalendar');
  const festBtnMap = document.getElementById('festBtnMap');
  const festCalendarView = document.getElementById('festCalendarView');
  const festMapView = document.getElementById('festMapView');

  function festShowCalendar() {
    festCalendarView!.style.display = '';
    festMapView!.style.display = 'none';
    festBtnCalendar!.classList.add('active');
    festBtnMap!.classList.remove('active');
  }

  function festShowMap() {
    festCalendarView!.style.display = 'none';
    festMapView!.style.display = '';
    festBtnCalendar!.classList.remove('active');
    festBtnMap!.classList.add('active');
    if (window.festMap) {
      window.festMap.invalidateSize();
    }
  }

  festBtnCalendar?.addEventListener('click', festShowCalendar);
  festBtnMap?.addEventListener('click', festShowMap);
</script>

<!-- Leaflet Map for Festivals -->
<script is:inline define:vars={{ markers: festMapMarkers }}>
  // Load Leaflet CSS
  if (!document.getElementById('leaflet-css')) {
    var lnk = document.createElement('link');
    lnk.id = 'leaflet-css';
    lnk.rel = 'stylesheet';
    lnk.href = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css';
    document.head.appendChild(lnk);
  }

  function initFestMap() {
    var mapEl = document.getElementById('festLeafletMap');
    if (!mapEl || typeof L === 'undefined') return;

    var map = L.map(mapEl, {
      center: [12.0, 122.5],
      zoom: 6,
      scrollWheelZoom: false,
      minZoom: 5,
      maxZoom: 12,
      maxBounds: [[4, 115], [22, 130]],
      zoomControl: false,
      attributionControl: false,
    });

    window.festMap = map;

    L.control.attribution({ prefix: false }).addTo(map);
    L.control.zoom({ position: 'topright' }).addTo(map);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '\u00a9 <a href="https://www.openstreetmap.org/copyright">OSM</a> \u00a9 <a href="https://carto.com/">CARTO</a>',
      maxZoom: 19,
    }).addTo(map);

    function makeCircle(color, size, stroke) {
      return L.divIcon({
        className: '',
        html: '<div style="width:' + size + 'px;height:' + size + 'px;border-radius:50%;background:' + color + ';border:2px solid ' + stroke + ';box-shadow:0 0 6px rgba(0,0,0,0.3);cursor:pointer;"></div>',
        iconSize: [size, size],
        iconAnchor: [size / 2, size / 2],
      });
    }

    var tooltip = document.getElementById('festMapTooltip');
    var tooltipName = document.getElementById('festTooltipName');
    var tooltipFests = document.getElementById('festTooltipFests');
    var container = document.getElementById('festMapContainer');

    markers.forEach(function(m) {
      var size = m.festivals.length > 1 ? 18 : 14;
      var icon = makeCircle(m.color, size, '#ffffff');
      var marker = L.marker([m.lat, m.lng], { icon: icon, title: m.label }).addTo(map);

      marker.on('mouseover', function(e) {
        if (tooltipName) tooltipName.textContent = m.label;
        if (tooltipFests) {
          tooltipFests.innerHTML = m.festivals.map(function(f) {
            return '<div class="fest-map-tooltip-fest"><span class="fest-map-tooltip-month">' + f.month + '</span> ' + f.name + '</div>';
          }).join('');
        }
        if (tooltip) tooltip.classList.add('fest-tooltip-visible');
        if (container && tooltip) {
          var pt = e.containerPoint;
          tooltip.style.left = (pt.x + 12) + 'px';
          tooltip.style.top = (pt.y - 10) + 'px';
        }
      });

      marker.on('mouseout', function() {
        if (tooltip) tooltip.classList.remove('fest-tooltip-visible');
      });

      marker.on('click', function() {
        window.location.href = m.url;
      });
    });
  }

  // Load Leaflet JS
  if (typeof L !== 'undefined') {
    initFestMap();
  } else {
    var lscript = document.createElement('script');
    lscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js';
    lscript.onload = initFestMap;
    document.head.appendChild(lscript);
  }
</script>

<style>
  /* ================================================================
     HERO — Festival gradient (warm coral → gold → deep night)
     ================================================================ */
  .fest-hero {
    position: relative;
    min-height: 60vh;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    padding: 5rem var(--space-6) 60px;
    overflow: hidden;
  }

  .fest-hero-video {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: 0;
  }

  .fest-hero-gradient {
    position: absolute;
    inset: 0;
    z-index: 1;
    background: linear-gradient(to bottom, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.15) 40%, rgba(0,0,0,0.55) 100%);
  }

  .fest-hero-noise {
    position: absolute;
    inset: 0;
    z-index: 2;
    background: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none;
  }

  .fest-hero-content {
    position: relative;
    z-index: 3;
    max-width: 720px;
  }

  .fest-hero-title {
    font-size: clamp(2rem, 5vw, 3.2rem);
    font-weight: var(--weight-bold);
    color: #fff;
    line-height: 1.1;
    margin: 0 0 var(--space-3);
  }

  .fest-hero-subtitle {
    font-size: clamp(1rem, 2vw, 1.15rem);
    color: rgba(255, 255, 255, 0.85);
    line-height: 1.6;
    margin: 0 0 var(--space-5);
    max-width: 580px;
  }

  .fest-hero-meta {
    display: flex;
    gap: var(--space-5);
    flex-wrap: wrap;
  }

  .fest-hero-meta-item {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .fest-hero-meta-label {
    font-size: 0.65rem;
    font-weight: var(--weight-semibold);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: rgba(255, 255, 255, 0.5);
  }

  .fest-hero-meta-value {
    font-size: 1.1rem;
    font-weight: var(--weight-bold);
    color: #fff;
  }

  .fest-scroll-hint {
    position: absolute;
    bottom: 16px;
    right: var(--space-6);
    z-index: 3;
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: rgba(255, 255, 255, 0.35);
    text-align: center;
    animation: festBounce 2s ease-in-out infinite;
  }

  @keyframes festBounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(6px); }
  }

  /* ================================================================
     CALENDAR GRID
     ================================================================ */
  .fest-calendar {
    padding: var(--space-10) 0 var(--space-8);
  }

  .fest-section-heading {
    font-size: clamp(1.5rem, 3vw, 2rem);
    font-weight: var(--weight-bold);
    color: var(--color-deep-night);
    margin: 0 0 var(--space-2);
    text-align: center;
  }

  .fest-section-sub {
    font-size: 1rem;
    color: var(--color-slate);
    text-align: center;
    margin: 0 0 var(--space-8);
  }

  .fest-month-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-5);
  }

  @media (max-width: 1024px) {
    .fest-month-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 640px) {
    .fest-month-grid {
      grid-template-columns: 1fr;
    }
  }

  /* ================================================================
     MONTH CARD
     ================================================================ */
  .fest-month-card {
    background: var(--color-white);
    border: 1px solid rgba(0, 0, 0, 0.06);
    border-radius: 16px;
    overflow: hidden;
    transition: box-shadow 0.3s ease;
  }

  .fest-month-card:hover {
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
  }

  .fest-month-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-3) var(--space-4);
    background: var(--color-sky);
    border-bottom: 1px solid rgba(0, 0, 0, 0.04);
  }

  .fest-month-name {
    font-size: 0.9rem;
    font-weight: var(--weight-bold);
    color: var(--color-deep-night);
    text-transform: uppercase;
    letter-spacing: 0.06em;
  }

  .fest-month-count {
    font-size: 0.7rem;
    font-weight: var(--weight-semibold);
    color: var(--color-warm-coral);
    background: rgba(232, 101, 74, 0.1);
    padding: 2px 8px;
    border-radius: 12px;
  }

  .fest-month-body {
    padding: var(--space-3);
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    min-height: 80px;
  }

  .fest-month-empty {
    display: flex;
    align-items: center;
    justify-content: center;
    flex: 1;
    font-size: 0.85rem;
    color: var(--color-slate);
    opacity: 0.5;
    font-style: italic;
  }

  /* ================================================================
     FESTIVAL ENTRY (within month card)
     ================================================================ */
  .fest-entry {
    position: relative;
    display: block;
    border-radius: 12px;
    overflow: hidden;
    text-decoration: none;
    color: inherit;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: 1px solid rgba(0, 0, 0, 0.05);
  }

  .fest-entry:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
  }

  .fest-entry-media {
    position: relative;
    aspect-ratio: 16 / 9;
    display: flex;
    align-items: flex-end;
    justify-content: flex-end;
    padding: var(--space-2);
    overflow: hidden;
  }

  .fest-card-video {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: 0;
    transition: opacity 0.8s ease;
  }

  .fest-card-scrim {
    position: absolute;
    inset: 0;
    z-index: 1;
    background: linear-gradient(to bottom, rgba(0,0,0,0.05) 0%, rgba(0,0,0,0.1) 40%, rgba(0,0,0,0.45) 100%);
  }

  .fest-entry-media-label {
    position: relative;
    z-index: 2;
    font-size: 0.6rem;
    font-weight: var(--weight-bold);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: rgba(255, 255, 255, 0.7);
    background: rgba(0, 0, 0, 0.25);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    padding: 2px 8px;
    border-radius: 6px;
  }

  .fest-entry-info {
    padding: var(--space-2) var(--space-3) var(--space-3);
    background: var(--color-white);
  }

  .fest-entry-name {
    font-size: 0.85rem;
    font-weight: var(--weight-bold);
    color: var(--color-deep-night);
    margin-bottom: 2px;
    line-height: 1.3;
  }

  .fest-entry-destination {
    font-size: 0.72rem;
    color: var(--color-ocean-teal);
    font-weight: var(--weight-medium);
  }

  /* Hover overlay */
  .fest-entry-overlay {
    position: absolute;
    inset: 0;
    background: rgba(26, 35, 50, 0.93);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding: var(--space-4);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .fest-entry:hover .fest-entry-overlay {
    opacity: 1;
  }

  .fest-entry-desc {
    font-size: 0.78rem;
    color: rgba(255, 255, 255, 0.9);
    line-height: 1.55;
    margin: 0 0 var(--space-3);
  }

  .fest-entry-cta {
    font-size: 0.72rem;
    font-weight: var(--weight-semibold);
    color: var(--color-warm-coral);
    letter-spacing: 0.02em;
  }

  /* ================================================================
     BOTTOM CTA
     ================================================================ */
  .fest-cta-section {
    padding: var(--space-6) 0 var(--space-8);
  }

  .fest-cta-card {
    background: linear-gradient(135deg, var(--color-deep-night) 0%, #2D3748 100%);
    border-radius: 20px;
    padding: var(--space-8) var(--space-6);
    text-align: center;
    color: #fff;
  }

  .fest-cta-heading {
    font-size: clamp(1.3rem, 3vw, 1.8rem);
    font-weight: var(--weight-bold);
    margin: 0 0 var(--space-3);
    color: #fff;
  }

  .fest-cta-text {
    font-size: 1rem;
    color: rgba(255, 255, 255, 0.75);
    max-width: 520px;
    margin: 0 auto var(--space-5);
    line-height: 1.6;
  }

  .fest-cta-button {
    display: inline-block;
    background: var(--color-warm-coral);
    color: #fff;
    font-size: 0.9rem;
    font-weight: var(--weight-semibold);
    padding: 12px 28px;
    border-radius: 40px;
    text-decoration: none;
    transition: background 0.2s ease, transform 0.2s ease;
  }

  .fest-cta-button:hover {
    background: #d4553b;
    transform: translateY(-2px);
  }

  /* ================================================================
     CROSS-LINKS
     ================================================================ */
  .fest-crosslinks {
    padding: 0 0 var(--space-10);
  }

  .fest-crosslinks-heading {
    font-size: 1.1rem;
    font-weight: var(--weight-bold);
    color: var(--color-deep-night);
    text-align: center;
    margin: 0 0 var(--space-4);
  }

  .fest-crosslinks-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-4);
    max-width: 640px;
    margin: 0 auto;
  }

  @media (max-width: 640px) {
    .fest-crosslinks-grid {
      grid-template-columns: 1fr;
    }
  }

  .fest-crosslink-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-5) var(--space-4);
    background: var(--color-white);
    border: 1px solid rgba(0, 0, 0, 0.06);
    border-radius: 16px;
    text-decoration: none;
    color: inherit;
    text-align: center;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .fest-crosslink-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
  }

  .fest-crosslink-icon {
    font-size: 1.8rem;
  }

  .fest-crosslink-label {
    font-size: 0.95rem;
    font-weight: var(--weight-bold);
    color: var(--color-deep-night);
  }

  .fest-crosslink-desc {
    font-size: 0.78rem;
    color: var(--color-slate);
    line-height: 1.4;
  }

  /* ================================================================
     RESPONSIVE — Hero adjustments
     ================================================================ */
  @media (max-width: 640px) {
    .fest-hero {
      min-height: 55vh;
      padding: 0 var(--space-4) 40px;
    }

    .fest-hero-meta {
      gap: var(--space-4);
    }

    .fest-scroll-hint {
      display: none;
    }
  }

  /* ================================================================
     VIEW TOGGLE
     ================================================================ */
  .fest-view-toggle {
    display: flex;
    justify-content: center;
    gap: 4px;
    background: var(--color-sand-dark);
    border-radius: 40px;
    padding: 4px;
    max-width: 240px;
    margin: 0 auto;
  }

  .fest-toggle-btn {
    flex: 1;
    padding: 8px 20px;
    border: none;
    border-radius: 36px;
    font-size: 0.82rem;
    font-weight: var(--weight-semibold);
    cursor: pointer;
    background: transparent;
    color: var(--color-slate);
    transition: background 0.2s ease, color 0.2s ease;
  }

  .fest-toggle-btn.active {
    background: var(--color-ocean-teal);
    color: #fff;
  }

  .fest-toggle-btn:hover:not(.active) {
    color: var(--color-deep-night);
  }

  /* ================================================================
     MAP VIEW
     ================================================================ */
  .fest-map-container {
    border-radius: 24px;
    position: relative;
    overflow: hidden;
    background: radial-gradient(ellipse at 40% 30%, #0c3547 0%, #091e2f 40%, #060f1a 100%);
    padding: 28px 20px 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35), inset 0 1px 0 rgba(255, 255, 255, 0.05);
    max-width: 600px;
    margin: 0 auto;
  }

  .fest-map-container::before {
    content: '';
    position: absolute;
    inset: 0;
    background:
      radial-gradient(ellipse 600px 300px at 30% 70%, rgba(13, 115, 119, 0.08) 0%, transparent 70%),
      radial-gradient(ellipse 400px 200px at 70% 20%, rgba(13, 115, 119, 0.06) 0%, transparent 70%);
    animation: festOceanShimmer 8s ease-in-out infinite alternate;
    pointer-events: none;
  }

  .fest-map-container::after {
    content: '';
    position: absolute;
    inset: 0;
    background-image:
      radial-gradient(circle 1px at 20% 30%, rgba(255, 255, 255, 0.03) 0%, transparent 100%),
      radial-gradient(circle 1px at 60% 50%, rgba(255, 255, 255, 0.02) 0%, transparent 100%),
      radial-gradient(circle 1px at 40% 80%, rgba(255, 255, 255, 0.02) 0%, transparent 100%);
    pointer-events: none;
  }

  @keyframes festOceanShimmer {
    0% { opacity: 0.5; }
    100% { opacity: 1; }
  }

  #festLeafletMap {
    width: 100%;
    height: 600px;
    border-radius: 16px;
    position: relative;
    z-index: 1;
  }

  .fest-map-tooltip {
    position: absolute;
    background: rgba(26, 35, 50, 0.95);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 10px 14px;
    pointer-events: none;
    opacity: 0;
    transform: translateY(4px);
    transition: opacity 0.2s ease, transform 0.2s ease;
    z-index: 50;
    min-width: 180px;
    max-width: 300px;
  }

  .fest-map-tooltip.fest-tooltip-visible {
    opacity: 1;
    transform: translateY(0);
  }

  .fest-map-tooltip-name {
    font-size: 0.85rem;
    font-weight: var(--weight-bold);
    color: white;
    margin-bottom: 4px;
  }

  :global(.fest-map-tooltip-fest) {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.85);
    line-height: 1.5;
  }

  :global(.fest-map-tooltip-month) {
    font-size: 0.6rem;
    font-weight: var(--weight-bold);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--color-warm-coral);
    margin-right: 4px;
  }

  .fest-map-legend {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-3) var(--space-4);
    flex-wrap: wrap;
    position: relative;
    z-index: 1;
  }

  .fest-map-legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.7rem;
    color: rgba(255, 255, 255, 0.45);
  }

  .fest-map-legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    box-shadow: 0 0 6px rgba(13, 115, 119, 0.5);
  }

  .fest-map-legend-note {
    font-size: 0.68rem;
    color: rgba(255, 255, 255, 0.35);
  }

  @media (max-width: 640px) {
    #festLeafletMap { height: 450px; }
  }

  /* Personal intro */
  .fest-personal {
    padding-block: var(--space-8);
  }

  .fest-personal-quote {
    max-width: 680px;
    margin: 0 auto;
    padding: var(--space-6) var(--space-8);
    border-left: 4px solid #D97706;
    background: var(--color-sky);
    border-radius: 0 12px 12px 0;
  }

  .fest-personal-quote p {
    font-size: var(--text-body);
    color: var(--color-heading);
    line-height: var(--leading-body);
    font-style: italic;
    margin-bottom: var(--space-3);
  }

  .fest-personal-quote cite {
    font-size: var(--text-caption);
    color: #D97706;
    font-weight: var(--weight-semibold);
    font-style: normal;
  }
</style>
